<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黒い点の検出と直径測定</title>
    <style>
        canvas {
            border: 1px solid black;
            margin-right: 20px;
        }
        #imageInput {
            margin-bottom: 10px;
        }
        #output {
            display: inline-block;
            vertical-align: top;
            margin-left: 20px;
        }
        .diameter-label {
            position: absolute;
            color: white;
            background-color: black;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>黒い点の検出と直径測定</h1>

    <input type="file" id="imageInput" accept="image/*">
    <button id="detectButton">黒い点を検出</button>
    <p>黒い点を個別に識別し、それぞれの最大直径を赤い線で表示します。</p>

    <div style="display: flex; align-items: center;">
        <canvas id="canvas"></canvas>
        <div id="output"></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageInput = document.getElementById('imageInput');
        const detectButton = document.getElementById('detectButton');
        const output = document.getElementById('output');

        let image = new Image();
        let labels = [];

        // 画像が選択されたときに表示する
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    image.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 画像をCanvasに描画する
        image.onload = () => {
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
        };

        // 黒い点を検出して、最大直径を計測・描画する
        detectButton.addEventListener('click', () => {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            let points = [];

            // 黒いピクセルを収集（RGBAデータの配列）
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const index = (y * canvas.width + x) * 4;
                    const r = data[index];     // Red
                    const g = data[index + 1]; // Green
                    const b = data[index + 2]; // Blue
                    const alpha = data[index + 3]; // Alpha (透明度)

                    // 黒に近いピクセルの判定（例: RGBがすべて50以下であれば黒とみなす）
                    if (r < 50 && g < 50 && b < 50 && alpha > 128) {
                        points.push({ x, y });
                    }
                }
            }

            // 黒い点をクラスタリング（近いピクセルを同じ点としてグループ化）
            const clusters = clusterPoints(points, 10); // 10ピクセル以内を同じ点とみなす

            // クラスタごとに最大直径を計測し、赤い線で表示
            clusters.forEach(cluster => {
                const diameter = calculateMaxDiameter(cluster);
                drawDiameterLine(cluster, diameter);
                displayDiameterLabel(cluster, diameter);
            });
        });

        // クラスタリング（点の集合をまとめる）
        function clusterPoints(points, maxDistance) {
            const clusters = [];
            points.forEach(point => {
                let addedToCluster = false;
                for (const cluster of clusters) {
                    if (isNearCluster(point, cluster, maxDistance)) {
                        cluster.push(point);
                        addedToCluster = true;
                        break;
                    }
                }
                if (!addedToCluster) {
                    clusters.push([point]);
                }
            });
            return clusters;
        }

        // クラスター内の2点間の最大距離（直径）を計算
        function calculateMaxDiameter(cluster) {
            let maxDistance = 0;
            let pointA = null;
            let pointB = null;

            for (let i = 0; i < cluster.length; i++) {
                for (let j = i + 1; j < cluster.length; j++) {
                    const dist = distance(cluster[i], cluster[j]);
                    if (dist > maxDistance) {
                        maxDistance = dist;
                        pointA = cluster[i];
                        pointB = cluster[j];
                    }
                }
            }

            return { maxDistance, pointA, pointB };
        }

        // 2点間の距離を計算
        function distance(point1, point2) {
            return Math.sqrt(Math.pow(point1.x - point2.x, 2) + Math.pow(point1.y - point2.y, 2));
        }

        // クラスターに近いかどうかを判定
        function isNearCluster(point, cluster, maxDistance) {
            return cluster.some(clusterPoint => distance(point, clusterPoint) <= maxDistance);
        }

        // 最大直径の線を描画
        function drawDiameterLine(cluster, diameter) {
            ctx.beginPath();
            ctx.moveTo(diameter.pointA.x, diameter.pointA.y);
            ctx.lineTo(diameter.pointB.x, diameter.pointB.y);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();
        }

        // 最大直径の長さを表示するラベルを作成
        function displayDiameterLabel(cluster, diameter) {
            const label = document.createElement('div');
            label.className = 'diameter-label';
            label.innerText = `${(diameter.maxDistance).toFixed(2)} px`;
            document.body.appendChild(label);

            const midX = (diameter.pointA.x + diameter.pointB.x) / 2;
            const midY = (diameter.pointA.y + diameter.pointB.y) / 2;

            label.style.left = `${canvas.offsetLeft + midX}px`;
            label.style.top = `${canvas.offsetTop + midY - 10}px`;

            labels.push(label);
        }
    </script>
</body>
</html>
